{{- if .Values.registration.enabled -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "daytona.fullname" . }}-region-registration
  namespace: {{ include "daytona.namespace" . }}
  labels:
    {{- include "daytona.labels" . | nindent 4 }}
    app.kubernetes.io/component: region-registration
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-5"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 3
  template:
    metadata:
      labels:
        {{- include "daytona.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: region-registration
    spec:
      serviceAccountName: {{ include "daytona.fullname" . }}-region-registration
      restartPolicy: OnFailure
      {{- with .Values.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      containers:
        - name: register
          image: {{ .Values.registration.image.repository }}:{{ .Values.registration.image.tag }}
          imagePullPolicy: {{ .Values.registration.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              set -e

              SECRET_NAME="{{ include "daytona.fullname" . }}-region-config"
              NAMESPACE="{{ include "daytona.namespace" . }}"

              # Function to create/update secret from JSON response
              create_secret() {
                local response="$1"
                echo "Creating/updating secret..."

                SECRET_DATA=$(echo "$response" | jq -r 'to_entries | .[] | "  \(.key): \(.value | tostring | @base64)"')

                cat > /tmp/secret.yaml <<SECRETEOF
              apiVersion: v1
              kind: Secret
              metadata:
                name: {{ include "daytona.fullname" . }}-region-config
                namespace: {{ include "daytona.namespace" . }}
                labels:
                  {{- include "daytona.labels" . | nindent 18 }}
                  app.kubernetes.io/component: region-config
              type: Opaque
              data:
              ${SECRET_DATA}
              SECRETEOF

                echo "Secret manifest:"
                cat /tmp/secret.yaml
                kubectl apply -f /tmp/secret.yaml
              }

              # Check if region config secret already exists
              if kubectl get secret "${SECRET_NAME}" -n "${NAMESPACE}" >/dev/null 2>&1; then
                echo "Region config secret '${SECRET_NAME}' exists."

                # Check if snapshot manager credentials are needed but missing
                if [ -n "${SNAPSHOT_MANAGER_URL}" ]; then
                  HAS_SM_CREDS=$(kubectl get secret "${SECRET_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.snapshotManagerUsername}' 2>/dev/null || echo "")

                  if [ -z "${HAS_SM_CREDS}" ]; then
                    echo "Snapshot manager URL configured but credentials missing. Regenerating..."

                    # Get region ID from existing secret
                    REGION_ID=$(kubectl get secret "${SECRET_NAME}" -n "${NAMESPACE}" -o jsonpath='{.data.id}' | base64 -d)

                    if [ -z "${REGION_ID}" ]; then
                      echo "Error: Could not get region ID from secret"
                      exit 1
                    fi

                    echo "Calling API to regenerate snapshot manager credentials for region ${REGION_ID}..."

                    SM_RESPONSE=$(curl -sf \
                      -X POST \
                      -H "Content-Type: application/json" \
                      -H "Authorization: Bearer ${DAYTONA_API_KEY}" \
                      "${DAYTONA_API_URL}/regions/${REGION_ID}/regenerate-snapshot-manager-credentials")

                    if [ -z "$SM_RESPONSE" ]; then
                      echo "Error: Empty response from regenerate credentials API"
                      exit 1
                    fi

                    echo "Credentials response received: $SM_RESPONSE"

                    # Get existing secret data and merge with new credentials
                    EXISTING_DATA=$(kubectl get secret "${SECRET_NAME}" -n "${NAMESPACE}" -o json | jq '.data | to_entries | map({(.key): (.value | @base64d)}) | add')

                    # Merge existing data with new snapshot manager credentials
                    MERGED_RESPONSE=$(echo "$EXISTING_DATA" | jq --argjson sm "$SM_RESPONSE" '. + {snapshotManagerUsername: $sm.username, snapshotManagerPassword: $sm.password}')

                    create_secret "$MERGED_RESPONSE"
                    echo "Snapshot manager credentials added to secret!"
                    exit 0
                  fi
                fi

                echo "Region already fully registered. Skipping."
                exit 0
              fi

              echo "Registering region with Daytona API..."

              # Build the request payload
              if [ -n "${SNAPSHOT_MANAGER_URL}" ]; then
                PAYLOAD=$(jq -n \
                  --arg name "${REGION_NAME}" \
                  --arg proxyUrl "${PROXY_URL}" \
                  --arg snapshotManagerUrl "${SNAPSHOT_MANAGER_URL}" \
                  '{name: $name, proxyUrl: $proxyUrl, snapshotManagerUrl: $snapshotManagerUrl}')
              else
                PAYLOAD=$(jq -n \
                  --arg name "${REGION_NAME}" \
                  --arg proxyUrl "${PROXY_URL}" \
                  '{name: $name, proxyUrl: $proxyUrl}')
              fi

              echo "Calling API at ${DAYTONA_API_URL}/regions..."

              # Call the API and capture response
              RESPONSE=$(curl -sf \
                -X POST \
                -H "Content-Type: application/json" \
                -H "Authorization: Bearer ${DAYTONA_API_KEY}" \
                -d "${PAYLOAD}" \
                "${DAYTONA_API_URL}/regions")

              if [ -z "$RESPONSE" ]; then
                echo "Error: Empty response from API"
                exit 1
              fi

              echo "API response received: $RESPONSE"
              create_secret "$RESPONSE"
              echo "Region registration complete!"
          env:
            - name: DAYTONA_API_URL
              value: {{ required "daytonaApiUrl is required" .Values.daytonaApiUrl | quote }}
            - name: DAYTONA_API_KEY
              valueFrom:
                secretKeyRef:
                  name: {{ .Values.registration.existingSecret | default (printf "%s-daytona-api-key" (include "daytona.fullname" .)) }}
                  key: {{ .Values.registration.secretKeys.apiKey | default "daytona-api-key" }}
            - name: PROXY_URL
              value: {{ include "daytona.proxyUrl" . | quote }}
            - name: REGION_NAME
              value: {{ required "regionName is required" .Values.regionName | quote }}
            {{- if .Values.snapshotManagerUrl }}
            - name: SNAPSHOT_MANAGER_URL
              value: {{ .Values.snapshotManagerUrl | quote }}
            {{- end }}
          resources:
            {{- toYaml .Values.registration.resources | nindent 12 }}
      {{- with .Values.registration.nodeSelector }}
      nodeSelector:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      {{- with .Values.registration.tolerations }}
      tolerations:
        {{- toYaml . | nindent 8 }}
      {{- end }}
---
{{- if not .Values.registration.existingSecret }}
apiVersion: v1
kind: Secret
metadata:
  name: {{ include "daytona.fullname" . }}-daytona-api-key
  namespace: {{ include "daytona.namespace" . }}
  labels:
    {{- include "daytona.labels" . | nindent 4 }}
    app.kubernetes.io/component: region-registration
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": before-hook-creation
type: Opaque
data:
  {{ .Values.registration.secretKeys.apiKey | default "daytona-api-key" }}: {{ required "daytonaApiKey is required" .Values.daytonaApiKey | b64enc | quote }}
{{- end }}
{{- end }}
